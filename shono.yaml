backbone:
  kind: kafka
  config:
    bootstrap_servers:
      - pkc-1wvvj.westeurope.azure.confluent.cloud:9092
    sasl:
      - mechanism: PLAIN
        username: ${KAFKA_API_KEY}
        password: ${KAFKA_API_SECRET}

storages:
  my_mongo:
    kind: mongodb
    config:
      uri: ${MDB_URI}
      database: "shono-dev"

scopes:
  todo:
    name: Todo
    description: Unit responsible for managing todo lists
    concepts:
      task:
        name: Task
        description: A task to be completed
        single: task
        plural: tasks
        store:
          storage: my_mongo
          collection: tasks

        events:
          operation_failed:
            name: Operation Failed
            description: An operation on a task failed
          creation_requested:
            name: Creation Requested
            description: An external system (like an API) requested a task to be created
          created:
            name: Created
            description: A task was created
          deletion_requested:
            name: Deletion Requested
            description: An external system (like an API) requested a task to be deleted
          deleted:
            name: Deleted
            description: A task was deleted
        on:
          todo__task__creation_requested:
            docs: |
              When a creation is requested, we create the task in the store and emit a created event if it succeeds.

            outputs:
                - todo__task__created: |
                    A task created event is emitted if the task was created successfully.
                - todo__task__operation_failed: |
                    An operation failed event is emitted if the task could not be created.

            logic:
              - store:
                  concept: todo__task
                  operation: add
                  key: ${! json("key") }
                  value: |
                    root.key = this.key
                    root.summary = this.summary
                    root.completed = false
                    root.timeline.createdAt = @kafka_timestamp_unix
              - mapping: |
                  meta io_shono_kind = "todo__task__created"
                  root.status = 210
                  root.task = this
              - catch:
                  - log:
                      level: ERROR
                      message: "Could not create task"
                  - transform: |
                      meta io_shono_kind = "todo__task__operation_failed"
                      root.status = 409
                      root.message = "task could not be created: ${! error()}"